<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FinVault Banks - Admin</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,Segoe UI,Arial}
    body{
      min-height:100vh;
      color:#0f172a;
      display:flex;
      justify-content:center;
      padding:28px;
      background:
        radial-gradient(1200px 600px at 18% 15%, rgba(59,130,246,0.35), transparent 55%),
        radial-gradient(1000px 520px at 85% 30%, rgba(34,197,94,0.28), transparent 55%),
        radial-gradient(900px 520px at 50% 95%, rgba(236,72,153,0.22), transparent 55%),
        linear-gradient(135deg,#f8fafc,#ecfeff,#fff7ed);
    }

    .app{
      width:min(1300px, 100%);
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }

    .card{
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(15,23,42,0.08);
      border-radius:22px;
      padding:18px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.10);
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .title{
      font-size:22px;
      font-weight:950;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#0f172a;
    }

    .badge{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background: rgba(59,130,246,0.12);
      border: 1px solid rgba(59,130,246,0.20);
      color:#1d4ed8;
      font-weight:950;
      white-space:nowrap;
    }

    .lang select{
      width:auto;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(255,255,255,0.85);
      color:#0f172a;
      outline:none;
      font-weight:900;
    }

    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .nav a{
      text-decoration:none;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      font-weight:950;
      color:#0f172a;
      transition:0.18s;
    }
    .nav a:hover{transform: translateY(-1px)}
    .nav a.primary{
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(99,102,241,0.95));
      color:#fff;
      box-shadow: 0 12px 22px rgba(59,130,246,0.16);
      border-color: transparent;
    }

    label{
      font-size:12px;
      color:#334155;
      display:block;
      margin:10px 0 6px;
      font-weight:900;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(255,255,255,0.85);
      color:#0f172a;
      outline:none;
      transition:0.2s;
    }

    input:focus, select:focus{
      border-color: rgba(59,130,246,0.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.14);
    }

    input::placeholder{color:#64748b}

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .btn{
      width:100%;
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,0.10);
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(99,102,241,0.95));
      color:#ffffff;
      font-weight:950;
      cursor:pointer;
      transition:0.18s;
      box-shadow: 0 12px 22px rgba(59,130,246,0.18);
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.03)}

    .btn.green{
      background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(16,185,129,0.95));
      box-shadow: 0 12px 22px rgba(34,197,94,0.18);
    }

    .btn.red{
      background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(244,63,94,0.95));
      box-shadow: 0 12px 22px rgba(239,68,68,0.18);
    }

    .btn.gray{
      background: rgba(15,23,42,0.06);
      color:#0f172a;
      box-shadow:none;
    }

    .msg{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.75);
      font-size:13px;
      line-height:1.35;
      min-height:44px;
      word-break: break-word;
    }

    .ok{border-color: rgba(34,197,94,0.35); color:#166534}
    .warn{border-color: rgba(245,158,11,0.35); color:#92400e}
    .bad{border-color: rgba(239,68,68,0.35); color:#991b1b}
    .muted{color:#475569}

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.65);
    }

    th, td{
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(15,23,42,0.06);
      font-size:13px;
      color:#0f172a;
      vertical-align:top;
    }

    th{
      background: rgba(15,23,42,0.04);
      font-size:12px;
      letter-spacing:0.35px;
      text-transform:uppercase;
      color:#334155;
    }

    tr:hover td{background: rgba(59,130,246,0.06)}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.85);
      color:#0f172a;
      font-weight:950;
      white-space:nowrap;
    }

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="card">
      <div class="topbar">
        <div class="title">üè¶ FinVault Banks <span class="badge" id="badgeRole">ADMIN</span></div>
        <div class="lang">
          <select id="lang" onchange="applyLang()">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
          </select>
        </div>
      </div>

      <div class="nav">
        <a class="primary" href="site.html" id="navAdmin">Admin Panel</a>
        <a href="requests.html" id="navRequests">Requests</a>
        <a href="user.html" id="navUser">User Portal</a>
        <a href="index.html" id="navHome">Home</a>
      </div>

      <label id="lblOp">Operation</label>
      <select id="op" onchange="toggleFields()">
        <option value="deposit">Deposit</option>
        <option value="withdraw">Withdraw</option>
        <option value="update">Full Update (Acc No + Name)</option>
        <option value="locker">Create Locker (Request)</option>
        <option value="delete">Delete Account</option>
      </select>

      <label id="lblAccNo">Account No</label>
      <input id="accNo" type="number" placeholder="Eg: 1001">

      <div class="row" id="rowAmountNewAcc">
        <div>
          <label id="lblAmount">Amount (‚Çπ)</label>
          <input id="amount" type="number" placeholder="Eg: 500">
        </div>
        <div>
          <label id="lblNewAcc">New Account No</label>
          <input id="newAccNo" type="number" placeholder="Eg: 2001">
        </div>
      </div>

      <label id="lblName">Name</label>
      <input id="name" type="text" placeholder="Eg: Rahul">

      <button class="btn" onclick="handleAction()" id="btnRun">Run Operation</button>
      <button class="btn gray" onclick="resetForm()" id="btnClear">Clear</button>
      <button class="btn red" onclick="wipeAll()" id="btnWipe">Wipe All Data</button>

      <div id="msg" class="msg muted">Ready.</div>
    </div>

    <div class="card">
      <div class="topbar" style="margin-bottom:10px;">
        <div class="title" style="font-size:18px; margin:0;">üìã Accounts</div>
        <input id="search" type="text" placeholder="Search by name / account no..." oninput="render()">
      </div>

      <table>
        <thead>
          <tr>
            <th>Acc No</th>
            <th>Name</th>
            <th>Balance</th>
            <th>Locker</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div style="margin-top:14px;"></div>

      <div class="topbar" style="margin-bottom:10px;">
        <div class="title" style="font-size:16px; margin:0;">üßæ Transactions (Last 20)</div>
        <input id="txAcc" type="number" placeholder="Account No" style="max-width:220px;">
      </div>

      <button class="btn green" onclick="loadTx()" style="margin-top:0;">Load Transactions</button>

      <div style="margin-top:12px;"></div>

      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Amount</th>
            <th>Before</th>
            <th>After</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="tbodyTx"></tbody>
      </table>
    </div>

  </div>

<script>
  const API = "http://127.0.0.1:5000/api";

  const T = {
    en: {
      ready: "Ready.",
      processing: "Processing...",
      confirmWipe: "Sure? This will delete everything from MySQL.",
      confirmDelete: "Sure? Account will be deleted."
    },
    hi: {
      ready: "Ready.",
      processing: "Processing...",
      confirmWipe: "Sure? This will delete everything from MySQL.",
      confirmDelete: "Sure? Account will be deleted."
    }
  };

  function lang(){ return document.getElementById("lang").value; }

  function setMsg(text, type="muted"){
    const el = document.getElementById("msg");
    el.className = "msg " + type;
    el.innerText = text;
  }

  function resetForm(){
    document.getElementById("op").value = "deposit";
    document.getElementById("accNo").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("newAccNo").value = "";
    document.getElementById("name").value = "";
    toggleFields();
    setMsg(T[lang()].ready, "muted");
  }

  function toggleFields(){
    const op = document.getElementById("op").value;

    document.getElementById("amount").disabled = true;
    document.getElementById("newAccNo").disabled = true;
    document.getElementById("name").disabled = true;

    if(op === "deposit" || op === "withdraw"){
      document.getElementById("amount").disabled = false;
    }
    if(op === "update"){
      document.getElementById("newAccNo").disabled = false;
      document.getElementById("name").disabled = false;
    }
    if(op === "locker"){
      document.getElementById("name").disabled = true;
    }
    if(op === "delete"){
      document.getElementById("name").disabled = true;
    }
  }

  function toMoney(x){
    return "‚Çπ " + Number(x).toFixed(2);
  }

  function escapeHtml(str){
    return str.replaceAll("&","&amp;")
              .replaceAll("<","&lt;")
              .replaceAll(">","&gt;")
              .replaceAll('"',"&quot;")
              .replaceAll("'","&#039;");
  }

  async function apiGET(url){
    const res = await fetch(url);
    const data = await res.json();
    if(!res.ok) throw new Error((data.msg || "Request failed") + (data.err ? (" | " + data.err) : ""));
    return data;
  }

  async function apiPOST(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!res.ok) throw new Error((data.msg || "Request failed") + (data.err ? (" | " + data.err) : ""));
    return data;
  }

  async function apiPUT(url, body){
    const res = await fetch(url, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!res.ok) throw new Error((data.msg || "Request failed") + (data.err ? (" | " + data.err) : ""));
    return data;
  }

  async function apiDELETE(url){
    const res = await fetch(url, { method: "DELETE" });
    const data = await res.json();
    if(!res.ok) throw new Error((data.msg || "Request failed") + (data.err ? (" | " + data.err) : ""));
    return data;
  }

  async function handleAction(){
    const op = document.getElementById("op").value;
    const accNo = Number(document.getElementById("accNo").value);
    const amount = Number(document.getElementById("amount").value);
    const newAccNo = Number(document.getElementById("newAccNo").value);
    const name = document.getElementById("name").value.trim();

    if(!accNo || accNo <= 0){
      setMsg("Valid account number enter kar.", "warn");
      return;
    }

    try{
      setMsg(T[lang()].processing, "muted");

      if(op === "deposit"){
        if(!amount || amount <= 0) return setMsg("Deposit amount > 0 hona chahiye.", "warn");
        const r = await apiPOST(`${API}/accounts/${accNo}/deposit`, { amount });
        setMsg(`Deposit OK. Balance: ${toMoney(r.after)}`, "ok");
      }

      else if(op === "withdraw"){
        if(!amount || amount <= 0) return setMsg("Withdraw amount > 0 hona chahiye.", "warn");
        const r = await apiPOST(`${API}/accounts/${accNo}/withdraw`, { amount });
        setMsg(`Withdraw OK. Balance: ${toMoney(r.after)}`, "ok");
      }

      else if(op === "update"){
        if(!newAccNo || newAccNo <= 0) return setMsg("New account number enter kar.", "warn");
        if(name.length < 2) return setMsg("Name valid enter kar.", "warn");
        await apiPUT(`${API}/accounts/${accNo}/full-update`, { new_acc_no: newAccNo, name });
        setMsg("Account update ho gaya.", "ok");
      }

      else if(op === "locker"){
        await apiPOST(`${API}/requests`, {
          acc_no: accNo,
          request_type: "CREATE_LOCKER",
          payload: {}
        });
        setMsg("Locker request create ho gaya. Requests page se approve kar.", "warn");
      }

      else if(op === "delete"){
        if(!confirm(T[lang()].confirmDelete)) return;
        const r = await apiDELETE(`${API}/accounts/${accNo}`);
        setMsg(r.msg, "ok");
      }

      await render();
    }
    catch(err){
      setMsg(err.message, "bad");
    }
  }

  async function render(){
    const tbody = document.getElementById("tbody");
    const q = document.getElementById("search").value.trim().toLowerCase();

    try{
      let rows = await apiGET(`${API}/accounts`);
      rows.sort((a,b) => a.acc_no - b.acc_no);

      rows = rows.filter(a => {
        if(!q) return true;
        return String(a.acc_no).includes(q) || a.name.toLowerCase().includes(q);
      });

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" style="padding:18px; color:#475569;">No accounts found.</td></tr>`;
        return;
      }

      const lockerMap = {};
      for(const a of rows){
        try{
          const l = await apiGET(`${API}/accounts/${a.acc_no}/locker`);
          lockerMap[a.acc_no] = l.locker_key;
        }catch(e){
          lockerMap[a.acc_no] = null;
        }
      }

      tbody.innerHTML = rows.map(a => `
        <tr>
          <td><span class="pill">${a.acc_no}</span></td>
          <td>${escapeHtml(a.name)}</td>
          <td><span class="pill">${toMoney(a.balance)}</span></td>
          <td>${lockerMap[a.acc_no] ? `<span class="pill">${lockerMap[a.acc_no]}</span>` : `<span style="color:#64748b;">None</span>`}</td>
        </tr>
      `).join("");
    }
    catch(err){
      tbody.innerHTML = `<tr><td colspan="4" style="padding:18px; color:#991b1b;">Backend not reachable.</td></tr>`;
    }
  }

  async function loadTx(){
    const accNo = Number(document.getElementById("txAcc").value);
    const tbodyTx = document.getElementById("tbodyTx");

    if(!accNo || accNo <= 0){
      tbodyTx.innerHTML = `<tr><td colspan="5" style="padding:18px; color:#475569;">Account number enter kar.</td></tr>`;
      return;
    }

    try{
      const tx = await apiGET(`${API}/accounts/${accNo}/transactions`);
      const last = tx.slice(0, 20);

      if(last.length === 0){
        tbodyTx.innerHTML = `<tr><td colspan="5" style="padding:18px; color:#475569;">No transactions found.</td></tr>`;
        return;
      }

      tbodyTx.innerHTML = last.map(t => `
        <tr>
          <td><span class="pill">${t.type}</span></td>
          <td>${toMoney(t.amount)}</td>
          <td>${toMoney(t.before_balance)}</td>
          <td>${toMoney(t.after_balance)}</td>
          <td>${new Date(t.created_at).toLocaleString()}</td>
        </tr>
      `).join("");
    }
    catch(err){
      tbodyTx.innerHTML = `<tr><td colspan="5" style="padding:18px; color:#991b1b;">${err.message}</td></tr>`;
    }
  }

  async function wipeAll(){
    if(!confirm(T[lang()].confirmWipe)) return;
    try{
      const r = await apiDELETE(`${API}/wipe`);
      setMsg(r.msg, "warn");
      await render();
    }catch(err){
      setMsg(err.message, "bad");
    }
  }

  function applyLang(){
    setMsg(T[lang()].ready, "muted");
    render();
  }

  toggleFields();
  applyLang();
</script>
</body>
</html>
